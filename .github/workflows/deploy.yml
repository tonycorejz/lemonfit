name: Deploy Lemonfit

on:
  push:
    branches:
      - main   # –∏–ª–∏ –¥—Ä—É–≥–∞—è –≤–µ—Ç–∫–∞ –¥–µ–ø–ª–æ—è

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build

      # üëá –ø–∞–∫—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
      - name: Archive production build
        run: |
          tar -czf lemonfit.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.* \
            .env.production || true

      # üëá –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Copy files to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "lemonfit.tar.gz"
          target: "/home/lemonfitadmin/lemonfit"

      # üëá –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º pm2
      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /home/lemonfitadmin/lemonfit

            # —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—è —Ñ–∞–π–ª—ã)
            tar -xzf lemonfit.tar.gz

            # –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å production-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω–∞–¥–æ)
            # npm ci --omit=dev

            # –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å pm2-–ø—Ä–æ—Ü–µ—Å—Å
            pm2 restart lemonfit || pm2 start npm --name lemonfit -- run start
            pm2 save
